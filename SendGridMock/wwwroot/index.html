<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SendGrid Mock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        .email-list-item.selected {
            background-color: #e5e7eb;
            border-left: 4px solid #3b82f6;
        }
        body { height: 100vh; overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900">
    <div id="app" v-cloak class="flex flex-col h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm z-10 p-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <svg class="w-8 h-8 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                </svg>
                <h1 class="text-xl font-bold tracking-tight">SendGrid Mock</h1>
            </div>
            <div class="flex gap-2">
                <a href="https://github.com/mdi1984/sendgrid-mock" target="_blank" class="text-gray-500 hover:text-gray-900 transition flex items-center mr-2" title="View on GitHub">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
                </a>
                <button @click="fetchMails" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium transition">
                    Refresh
                </button>
                <button @click="clearMails" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm font-medium transition">
                    Clear All
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar / Email List -->
            <div class="w-1/3 bg-white border-r border-gray-200 overflow-y-auto flex flex-col">
                <div v-if="mails.length === 0" class="p-8 text-center text-gray-400">
                    No emails found.
                </div>
                <div v-for="mail in mails" :key="mail.id" 
                     @click="selectMail(mail)"
                     class="email-list-item p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition duration-150 ease-in-out"
                     :class="{ 'selected': selectedMail && selectedMail.id === mail.id }">
                    <div class="flex justify-between items-baseline mb-1">
                        <span class="font-semibold truncate w-2/3" :title="formatAddress(mail.message.from)">
                            {{ formatName(mail.message.from) }}
                        </span>
                        <span class="text-xs text-gray-500">{{ formatTime(mail.receivedAt) }}</span>
                    </div>
                    <div class="font-medium text-sm text-gray-800 mb-1 truncate">
                        {{ getSubject(mail.message) }}
                    </div>
                    <div class="text-xs text-gray-500 truncate">
                        To: {{ formatRecipients(mail.message) }}
                    </div>
                </div>
            </div>

            <!-- Detail View -->
            <div class="w-2/3 bg-gray-50 flex flex-col overflow-hidden relative">
                <div v-if="!selectedMail" class="flex-1 flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-16 h-16 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2.94 6.412A2 2 0 002 8.108V16a2 2 0 002 2h12a2 2 0 002-2V8.108a2 2 0 00-.94-1.696l-6-3.75a2 2 0 00-2.12 0l-6 3.75zm2.615 2.423a1 1 0 10-1.11 1.664l5 3.333a1 1 0 001.11 0l5-3.333a1 1 0 00-1.11-1.664L10 11.798 5.555 8.835z" clip-rule="evenodd" />
                    </svg>
                    <p>Select an email to view details</p>
                </div>

                <div v-else class="flex flex-col h-full">
                    <!-- Email Header -->
                    <div class="bg-white p-6 shadow-sm border-b border-gray-200 shrink-0">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">{{ getSubject(selectedMail.message) }}</h2>
                        
                        <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 text-sm">
                            <div class="text-gray-500 text-right">From:</div>
                            <div class="font-medium">
                                {{ formatAddress(selectedMail.message.from) }}
                            </div>

                            <div class="text-gray-500 text-right">To:</div>
                            <div>
                                <span v-for="(to, idx) in getAllRecipients(selectedMail.message)" :key="idx" 
                                      class="inline-block bg-blue-50 text-blue-700 px-2 py-0.5 rounded mr-1 mb-1 border border-blue-100">
                                    {{ formatAddress(to) }}
                                </span>
                            </div>
                            

                            <div class="text-gray-500 text-right">Date:</div>
                            <div class="text-gray-700">
                                {{ new Date(selectedMail.receivedAt).toLocaleString() }}
                            </div>
                        </div>

                        <!-- Attachments Chips -->
                        <div v-if="selectedMail.message.attachments && selectedMail.message.attachments.length" class="mt-4 pt-4 border-t border-gray-100">
                            <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Attachments</div>
                            <div class="flex flex-wrap gap-2">
                                <button v-for="(att, idx) in selectedMail.message.attachments" :key="idx" 
                                     @click="downloadAttachment(att)"
                                     class="flex items-center text-sm border bg-gray-50 px-3 py-1.5 rounded-full hover:bg-gray-100 cursor-pointer transition-colors"
                                     title="Download attachment">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="truncate max-w-xs">{{ att.filename }}</span>
                                    <span class="ml-2 text-xs text-gray-400">({{ att.type }})</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="bg-gray-100 border-b border-gray-200 px-6 flex">
                        <button v-for="tab in availableTabs" :key="tab"
                                @click="currentTab = tab"
                                class="px-4 py-3 text-sm font-medium border-b-2 transition-colors duration-150"
                                :class="currentTab === tab ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            {{ tab }}
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="flex-1 overflow-auto bg-white relative">
                        <!-- HTML View -->
                        <div v-if="currentTab === 'HTML' && htmlContent" class="h-full w-full">
                            <iframe ref="mailFrame" class="w-full h-full border-0" :srcdoc="htmlContent" sandbox="allow-same-origin"></iframe>
                        </div>
                        <div v-else-if="currentTab === 'HTML'" class="flex h-full items-center justify-center text-gray-400 italic">
                            No HTML content
                        </div>

                        <!-- Text View -->
                        <div v-if="currentTab === 'Text' && textContent" class="p-6 font-mono text-sm whitespace-pre-wrap text-gray-800">
                            {{ textContent }}
                        </div>
                        <div v-else-if="currentTab === 'Text'" class="flex h-full items-center justify-center text-gray-400 italic">
                            No plain text content
                        </div>

                        <!-- JSON View -->
                        <div v-if="currentTab === 'JSON'" class="p-0 h-full">
                            <pre class="p-4 text-xs font-mono bg-gray-50 h-full overflow-auto text-gray-700">{{ JSON.stringify(selectedMail.message, null, 2) }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const mails = ref([]);
                const selectedMail = ref(null);
                const currentTab = ref('HTML');

                const fetchMails = async () => {
                    try {
                        const res = await fetch('/api/mails');
                        if (res.ok) {
                            mails.value = await res.json();
                            // If we have a selected mail, update its data if it still exists
                            if (selectedMail.value) {
                                const fresh = mails.value.find(m => m.id === selectedMail.value.id);
                                if (fresh) selectedMail.value = fresh;
                            }
                        }
                    } catch (e) {
                        console.error("Failed to fetch mails", e);
                    }
                };

                const clearMails = async () => {
                    if (!confirm('Are you sure you want to delete all emails?')) return;
                    await fetch('/api/mails', { method: 'DELETE' });
                    selectedMail.value = null;
                    await fetchMails();
                };

                const selectMail = (mail) => {
                    selectedMail.value = mail;
                    // Default to HTML if available, else Text
                    const hasHtml = getHtml(mail.message);
                    currentTab.value = hasHtml ? 'HTML' : 'Text';
                };

                const formatName = (addr) => {
                    if (!addr) return 'Unknown';
                    return addr.name || addr.email || 'Unknown';
                };

                const getSubject = (msg) => {
                    if (msg.subject) return msg.subject;
                    if (msg.personalizations && msg.personalizations.length > 0) {
                        const p = msg.personalizations.find(x => x.subject);
                        if (p) return p.subject;
                    }
                    return '(No Subject)';
                };

                const formatAddress = (addr) => {
                    if (!addr) return '';
                    if (addr.name) return `${addr.name} <${addr.email}>`;
                    return addr.email;
                };

                const formatTime = (isoString) => {
                    return dayjs(isoString).format('MMM D, HH:mm');
                };

                const formatRecipients = (msg) => {
                    if (!msg.personalizations || msg.personalizations.length === 0) return 'No recipients';
                    // Show first To from first personalization
                    const firstP = msg.personalizations[0];
                    if (firstP.to && firstP.to.length > 0) {
                        const count = firstP.to.length;
                        const first = formatName(firstP.to[0]);
                        return count > 1 ? `${first} +${count - 1}` : first;
                    }
                    return 'No recipients';
                };

                const getAllRecipients = (msg) => {
                    const recips = [];
                    if (msg.personalizations) {
                        msg.personalizations.forEach(p => {
                            if (p.to) recips.push(...p.to);
                        });
                    }
                    return recips;
                };

                const getHtml = (msg) => {
                    if (!msg.content) return null;
                    const c = msg.content.find(x => x.type === 'text/html');
                    return c ? c.value : null;
                };

                const getText = (msg) => {
                    if (!msg.content) return null;
                    const c = msg.content.find(x => x.type === 'text/plain');
                    return c ? c.value : null;
                };

                const htmlContent = computed(() => {
                    if (!selectedMail.value) return null;
                    let html = getHtml(selectedMail.value.message);
                    if (!html) return null;

                    // Substitute cid: attachments with data URIs
                    const attachments = selectedMail.value.message.attachments;
                    if (attachments && attachments.length > 0) {
                        attachments.forEach(att => {
                            if (att.content_id && att.content) {
                                let type = att.type;
                                // Infer type from filename if missing
                                if (!type && att.filename) {
                                    const ext = att.filename.split('.').pop().toLowerCase();
                                    if (ext === 'png') type = 'image/png';
                                    else if (ext === 'jpg' || ext === 'jpeg') type = 'image/jpeg';
                                    else if (ext === 'gif') type = 'image/gif';
                                    else if (ext === 'svg') type = 'image/svg+xml';
                                }
                                if (!type) type = 'application/octet-stream';

                                const dataUri = `data:${type};base64,${att.content}`;
                                const cid = att.content_id.replace(/^<|>$/g, ''); // Remove angle brackets if present
                                
                                // Replace cid:<id> with data URI (global replacement)
                                // Escaping cid for regex safety might be good, but alphanumeric is standard
                                const regex = new RegExp(`cid:${cid}`, 'g');
                                html = html.replace(regex, dataUri);
                            }
                        });
                    }
                    return html;
                });

                const textContent = computed(() => {
                    if (!selectedMail.value) return null;
                    return getText(selectedMail.value.message);
                });

                const availableTabs = computed(() => {
                    return ['HTML', 'Text', 'JSON'];
                });

                const downloadAttachment = (att) => {
                    const link = document.createElement('a');
                    link.href = `data:${att.type || 'application/octet-stream'};base64,${att.content}`;
                    link.download = att.filename || 'download';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                onMounted(() => {
                    fetchMails();
                    // Poll every 5 seconds
                    setInterval(fetchMails, 5000);
                });

                return {
                    mails,
                    selectedMail,
                    currentTab,
                    fetchMails,
                    clearMails,
                    selectMail,
                    formatName,
                    formatAddress,
                    formatTime,
                    formatRecipients,
                    getAllRecipients,
                    getSubject,
                    htmlContent,
                    textContent,
                    availableTabs,
                    downloadAttachment
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
